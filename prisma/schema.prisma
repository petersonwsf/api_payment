
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum CaptureMethod {
  AUTOMATIC
  MANUAL
}

enum PaymentStatus {
  CREATED
  REQUIRES_ACTION
  AUTHORIZED
  CAPTURED
  CANCELED
  FAILED
  REFUNDED
}

model Payment {
  id                    Int @id @default(autoincrement())
  reservationId         Int
  userId                Int
  stripePaymentIntentId String @unique
  amountAuthorized      Int
  amountCaptured        Int    @default(0)
  currency              String @default("brl")
  status                PaymentStatus
  captureMethod         CaptureMethod
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

enum WebhookProcessStatus {
  RECEIVED
  PROCESSED
  FAILED
  IGNORED
}

model StripeWebhookEvent {
  id              Int    @id @default(autoincrement())
  stripeEventId   String @unique
  type            String
  apiVersion      String?
  livemode        Boolean @default(false)
  requestId       String?
  idempotencyId   String?
  paymentIntentId String?
  reservationId   Int?
  payload         Json
  receivedAt      DateTime @default(now())
  processedAt     DateTime? 
  status          WebhookProcessStatus @default(RECEIVED)
  errorMessage    String?

  @@index([type])
  @@index([paymentIntentId])
  @@index([reservationId])
  @@index([status, receivedAt])
}